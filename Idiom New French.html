<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Aventure sur l‚Äô√éle des Expressions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Inter:wght@400;500;600,700&display=swap');
    .game-font { font-family: 'Fredoka One', cursive; }
    .body-font { font-family: 'Inter', sans-serif; }
    .island-bg { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; }
    .zone-card { transition:all .3s ease; }
    .zone-card:hover { transform: translateY(-5px); box-shadow:0 20px 40px rgba(0,0,0,.1); }
    .zone-locked { opacity:.6; filter:grayscale(100%); }
    .progress-bar { transition:width .5s ease; }
    .drag-item { cursor:grab; }
    .drop-zone { min-height:60px; transition:all .2s ease; }
    .drop-zone.drag-over { background-color:#e0f2fe; border-color:#0284c7; }
    .correct-match { background-color:#dcfce7!important; border-color:#16a34a!important; }
    .wrong-match   { background-color:#fef2f2!important; border-color:#dc2626!important; }
    @keyframes bounce { 0%,20%,50%,80%,100%{transform:translateY(0);}40%{transform:translateY(-10px);}60%{transform:translateY(-5px);} }
    .bounce-animation { animation:bounce .6s; }
    .timer-warning { animation:pulse 1s infinite; }
    @keyframes pulse { 0%{opacity:1;}50%{opacity:.5;}100%{opacity:1;} }
  </style>
</head>
<body class="island-bg body-font">

  <div id="app" class="min-h-screen">

    <div id="mainMenu" class="container mx-auto px-4 py-8">
      <div class="text-center mb-12">
        <h1 class="game-font text-6xl text-white mb-4">üèùÔ∏è Aventure sur l‚Äô√éle des Expressions</h1>
        <p class="text-xl text-blue-100 mb-8">
          Ma√Ætrisez 100 expressions fran√ßaises √† travers des d√©fis captivants !
        </p>
        <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-6 max-w-md mx-auto mb-8">
          <div class="flex justify-between items-center mb-4">
            <span class="text-white font-semibold">Score total :</span>
            <span id="totalScore" class="text-2xl font-bold text-yellow-300">0</span>
          </div>
          <div class="w-full bg-white/20 rounded-full h-3">
            <div id="overallProgress"
                 class="progress-bar bg-gradient-to-r from-yellow-400 to-orange-500 h-3 rounded-full"
                 style="width:0%"></div>
          </div>
          <p class="text-blue-100 text-sm mt-2">Progression vers Ma√Ætrise</p>
        </div>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
        <div class="zone-card bg-white rounded-2xl p-6 shadow-xl" data-zone="1">
          <div class="text-center">
            <div class="text-4xl mb-4">üåü</div>
            <h3 class="game-font text-2xl text-blue-600 mb-2">Baie des Associations</h3>
            <p class="text-gray-600 mb-4">Associez expressions et significations</p>
            <div class="flex justify-between text-sm text-gray-500 mb-4">
              <span>Max : 100 pts</span>
              <span id="zone1Score">Score : 0</span>
            </div>
            <button onclick="startZone(1)"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full font-semibold">
              Commencer l‚Äôaventure
            </button>
          </div>
        </div>
        <div class="zone-card bg-white rounded-2xl p-6 shadow-xl zone-locked" data-zone="2">
          <div class="text-center">
            <div class="text-4xl mb-4">‚ùì</div>
            <h3 class="game-font text-2xl text-gray-400 mb-2">Falaises Vrai/Faux</h3>
            <p class="text-gray-400 mb-4">D√©fis Vrai ou Faux</p>
            <div class="flex justify-between text-sm text-gray-400 mb-4">
              <span>Max : 100 pts</span>
              <span id="zone2Score">Score : 0</span>
            </div>
            <button class="bg-gray-300 text-gray-500 px-6 py-2 rounded-full cursor-not-allowed">
              üîí Verrouill√©
            </button>
          </div>
        </div>
        <div class="zone-card bg-white rounded-2xl p-6 shadow-xl zone-locked" data-zone="3">
          <div class="text-center">
            <div class="text-4xl mb-4">‚úçÔ∏è</div>
            <h3 class="game-font text-2xl text-gray-400 mb-2">Tr√©sor Cach√©</h3>
            <p class="text-gray-400 mb-4">Compl√©tez les phrases</p>
            <div class="flex justify-between text-sm text-gray-400 mb-4">
              <span>Max : 150 pts</span>
              <span id="zone3Score">Score : 0</span>
            </div>
            <button class="bg-gray-300 text-gray-500 px-6 py-2 rounded-full cursor-not-allowed">
              üîí Verrouill√©
            </button>
          </div>
        </div>
        <div class="zone-card bg-white rounded-2xl p-6 shadow-xl zone-locked" data-zone="4">
          <div class="text-center">
            <div class="text-4xl mb-4">‚ö°</div>
            <h3 class="game-font text-2xl text-gray-400 mb-2">Lagune √âclair</h3>
            <p class="text-gray-400 mb-4">Quiz chronom√©tr√©</p>
            <div class="flex justify-between text-sm text-gray-400 mb-4">
              <span>Max : 100 pts</span>
              <span id="zone4Score">Score : 0</span>
            </div>
            <button class="bg-gray-300 text-gray-500 px-6 py-2 rounded-full cursor-not-allowed">
              üîí Verrouill√©
            </button>
          </div>
        </div>
        <div class="zone-card bg-white rounded-2xl p-6 shadow-xl zone-locked" data-zone="5">
          <div class="text-center">
            <div class="text-4xl mb-4">üåÄ</div>
            <h3 class="game-font text-2xl text-gray-400 mb-2">Labyrinthe des Expressions</h3>
            <p class="text-gray-400 mb-4">Sc√©narios pratiques</p>
            <div class="flex justify-between text-sm text-gray-400 mb-4">
              <span>Max : 80 pts</span>
              <span id="zone5Score">Score : 0</span>
            </div>
            <button class="bg-gray-300 text-gray-500 px-6 py-2 rounded-full cursor-not-allowed">
              üîí Verrouill√©
            </button>
          </div>
        </div>
        <div class="zone-card bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl p-6 shadow-xl">
          <div class="text-center text-white">
            <div class="text-4xl mb-4">üèÜ</div>
            <h3 class="game-font text-2xl mb-2">Votre Rang</h3>
            <p id="playerRank" class="text-lg font-semibold mb-2">Continuez √† pratiquer üí°</p>
            <div class="text-sm opacity-90">
              <div>üèÜ 500+ pts : Champion</div>
              <div>üß≠ 400+ pts : Explorateur</div>
              <div>üí° 0+ pts : Apprenti</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="gameScreen" class="hidden container mx-auto px-4 py-8">

      <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-4 mb-6 flex justify-between items-center">
        <button onclick="returnToMenu()"
                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg">
          ‚Üê Retour √† l‚Äô√Æle
        </button>
        <div class="text-center">
          <h2 id="zoneTitle" class="game-font text-2xl text-white"></h2>
          <p id="zoneDescription" class="text-blue-100"></p>
        </div>
        <div class="text-right">
          <div class="text-white font-semibold">
            Score : <span id="currentScore">0</span>
          </div>
          <div id="timerDisplay" class="text-yellow-300 font-bold hidden"></div>
        </div>
      </div>

      <div id="zone1Game" class="hidden">
        <div class="bg-white rounded-2xl p-6 shadow-xl">
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">Progression</span>
              <span id="matchProgress">0/10</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="matchProgressBar"
                   class="progress-bar bg-blue-500 h-3 rounded-full"
                   style="width:0%"></div>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-8">
            <div>
              <h3 class="font-bold text-lg mb-4 text-center">Expressions</h3>
              <div id="idiomsColumn" class="space-y-3"></div>
            </div>
            <div>
              <h3 class="font-bold text-lg mb-4 text-center">Significations</h3>
              <div id="meaningsColumn" class="space-y-3"></div>
            </div>
          </div>
          <div class="text-center mt-6">
            <button id="checkMatches" onclick="checkMatches()"
                    class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full font-semibold">
              V√©rifier
            </button>
          </div>
        </div>
      </div>

      <div id="zone2Game" class="hidden">
        <div class="bg-white rounded-2xl p-6 shadow-xl max-w-2xl mx-auto">
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">Question <span id="tfQuestionNum">1</span>/10</span>
              <span class="text-red-500 font-semibold">Vies : <span id="livesCount">3</span></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="tfProgressBar"
                   class="progress-bar bg-purple-500 h-3 rounded-full"
                   style="width:10%"></div>
            </div>
          </div>
          <div class="text-center mb-8">
            <div class="bg-blue-50 rounded-xl p-6 mb-6">
              <h3 id="tfIdiom" class="text-2xl font-bold text-blue-600 mb-4"></h3>
              <p id="tfDefinition" class="text-lg text-gray-700"></p>
            </div>
            <div class="space-x-4">
              <button onclick="answerTrueFalse(true)"
                      class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full font-bold">
                VRAI
              </button>
              <button onclick="answerTrueFalse(false)"
                      class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-full font-bold">
                FAUX
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="zone3Game" class="hidden">
        <div class="bg-white rounded-2xl p-6 shadow-xl max-w-2xl mx-auto">
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">Question <span id="fibQuestionNum">1</span>/10</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="fibProgressBar"
                   class="progress-bar bg-green-500 h-3 rounded-full"
                   style="width:10%"></div>
            </div>
          </div>
          <div class="text-center mb-8">
            <div class="bg-green-50 rounded-xl p-6 mb-6">
              <p id="fibSentence" class="text-lg text-gray-700 mb-4"></p>
              <select id="fibSelect"
                      class="border-2 border-green-300 rounded-lg px-4 py-2 text-lg font-semibold bg-white">
                <option value="">Choisissez une expression‚Ä¶</option>  
              </select>
            </div>
            <button onclick="submitFillBlank()"
                    class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full font-semibold">
              Valider
            </button>
          </div>
        </div>
      </div>

      <div id="zone4Game" class="hidden">
        <div class="bg-white rounded-2xl p-6 shadow-xl max-w-2xl mx-auto">
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">Question <span id="lrQuestionNum">1</span>/10</span>
              <span id="lrTimer" class="text-2xl font-bold text-red-500">60</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="lrProgressBar"
                   class="progress-bar bg-yellow-500 h-3 rounded-full"
                   style="width:10%"></div>
            </div>
          </div>
          <div class="text-center mb-8">
            <div class="bg-yellow-50 rounded-xl p-6 mb-6">
              <h3 id="lrIdiom" class="text-2xl font-bold text-yellow-600 mb-4"></h3>
            </div>
            <div id="lrOptions" class="grid grid-cols-2 gap-4"></div>
          </div>
        </div>
      </div>

      <div id="zone5Game" class="hidden">
        <div class="bg-white rounded-2xl p-6 shadow-xl max-w-3xl mx-auto">
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold">Sc√©nario <span id="scenarioNum">1</span>/4</span>
              <span class="font-semibold">D√©fi final ! üåü</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="scenarioProgressBar"
                   class="progress-bar bg-purple-500 h-3 rounded-full"
                   style="width:25%"></div>
            </div>
          </div>
          <div class="mb-8">
            <div class="bg-purple-50 rounded-xl p-6 mb-6">
              <h3 id="scenarioTitle" class="text-xl font-bold text-purple-600 mb-4"></h3>
              <p id="scenarioDescription" class="text-gray-700 mb-4"></p>
              <p id="scenarioQuestion" class="font-semibold text-gray-800"></p>
            </div>
            <div id="scenarioOptions" class="space-y-3"></div>
          </div>
        </div>
      </div>

    </div>

    <div id="resultsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
        <div id="resultsIcon" class="text-6xl mb-4"></div>
        <h3 id="resultsTitle" class="game-font text-2xl mb-4"></h3>
        <p id="resultsMessage" class="text-gray-600 mb-6"></p>
        <div id="resultsScore" class="text-3xl font-bold text-blue-600 mb-6"></div>
        <button onclick="closeResults()"
                class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-full font-semibold">
          Continuer
        </button>
      </div>
    </div>

  </div>

  <script>
  //
  // Core Game State (identifiers in English)
  //
  const gameData = {
    totalScore:   0,
    zoneScores:   [0,0,0,0,0],
    unlockedZones:[true,false,false,false,false],
    currentZone:  0,
    currentQuestion:0,
    gameState:    {}
  };

  // Titles & Descriptions in French
  const zoneInfo = {
    1:{ title:'üåü Baie des Associations',    desc:'Associez expressions et significations'},
    2:{ title:'‚ùì Falaises Vrai/Faux',        desc:'D√©fis Vrai ou Faux'},
    3:{ title:'‚úçÔ∏è Tr√©sor Cach√©',             desc:'Compl√©tez les phrases'},
    4:{ title:'‚ö° Lagune √âclair',            desc:'Quiz chronom√©tr√©'},
    5:{ title:'üåÄ Labyrinthe des Expressions',desc:'Sc√©narios pratiques'}
  };

  // Sample Data: French Idioms & Scenarios (FIXED)
  const idiomsData = {
    zone1:[
      {idiom:"Appeler un chat un chat",    meaning:"Dire les choses telles qu'elles sont"},
      {idiom:"Tourner autour du pot",       meaning:"Ne pas aborder directement un sujet"},
      {idiom:"Faire d'une pierre deux coups",meaning:"Accomplir deux choses √† la fois"},
      {idiom:"Co√ªter les yeux de la t√™te",  meaning:"√ätre tr√®s co√ªteux"},
      {idiom:"Ce n'est pas la mer √† boire", meaning:"Ce n'est pas si difficile"},
      {idiom:"Prendre la mouche",           meaning:"Se vexer facilement"},
      {idiom:"Avoir la t√™te dans les nuages",meaning:"√ätre distrait, r√™veur"},
      {idiom:"Casser du sucre sur le dos",  meaning:"Critiquer en l'absence de quelqu'un"},
      {idiom:"Avoir le c≈ìur sur la main",   meaning:"√ätre tr√®s g√©n√©reux"},
      {idiom:"Jeter l'argent par les fen√™tres",meaning:"Gaspiller son argent"}
    ],
    zone2:[
      {idiom:"Battre le fer tant qu'il est chaud",meaning:"Profiter du bon moment", correct:true},
      {idiom:"Couper l'herbe sous le pied",        meaning:"Devancer quelqu'un", correct:true},
      {idiom:"Mettre la charrue avant les b≈ìufs",  meaning:"Agir dans le d√©sordre", correct:true}, // (FIXED from false to true)
      {idiom:"Tourner autour du pot",              meaning:"Aller droit au but", correct:false},
      {idiom:"Manger sur le pouce",                meaning:"Manger rapidement", correct:true},
      {idiom:"√ätre sur son trente-et-un",          meaning:"√ätre habill√© de fa√ßon n√©glig√©e", correct:false},
      {idiom:"Avoir un coup de foudre",            meaning:"Tomber amoureux soudainement", correct:true},
      {idiom:"Poser un lapin",                     meaning:"Ne pas venir √† un rendez-vous", correct:true},
      {idiom:"Avoir la puce √† l‚Äôoreille",          meaning:"√ätre parfaitement confiant", correct:false},
      {idiom:"Donner sa langue au chat",           meaning:"Abandonner une devinette", correct:true}
    ],
    zone3:[
      {
        sentence:"Il faut ______ pour dire les choses telles qu'elles sont.",
        answer:"appeler un chat un chat",
        options:[
          "appeler un chat un chat",
          "tourner autour du pot",
          "prendre la mouche",
          "co√ªter les yeux de la t√™te"
        ]
      },
      { // (FIXED QUESTION)
        sentence:"Ce projet est trop difficile, je crois que je vais ______.",
        answer:"donner ma langue au chat",
        options:[
          "donner ma langue au chat",
          "prendre la mouche",
          "faire d'une pierre deux coups",
          "manger sur le pouce"
        ]
      },
      { // (FIXED QUESTION)
        sentence:"N'ach√®te pas la voiture avant de l'essayer, il ne faut pas ______.",
        answer:"mettre la charrue avant les b≈ìufs",
        options:[
          "mettre la charrue avant les b≈ìufs",
          "couper l'herbe sous le pied",
          "√™tre sur son trente-et-un",
          "poser un lapin"
        ]
      },
      // ‚Ä¶ up to 10 ‚Ä¶
    ],
    zone4:[
      {
        idiom:"Appeler un chat un chat",
        options:["Dire clairement","Mentir","Parler d'animaux","Jouer avec un chat"],
        answer:0
      },
      {
        idiom:"Tourner autour du pot",
        options:["√âviter le sujet","Casser un pot","Ramasser des fleurs","Prendre un pot"],
        answer:0
      },
      // ‚Ä¶ up to 10 ‚Ä¶
    ],
    zone5:[
      {
        title:"Rendez-vous Manqu√©",
        description:"Vous avez oubli√© un rendez-vous important avec un ami.",
        question:"Quelle expression utilisez-vous pour vous excuser ?",
        options:[
          {text:"Je suis d√©sol√©, je t'ai pos√© un lapin.", idiom:"poser un lapin", correct:true},
          {text:"D√©sol√©, j'ai tourn√© autour du pot.", idiom:"tourner autour du pot", correct:false},
          {text:"D√©sol√©, j'ai cass√© du sucre sur ton dos.", idiom:"casser du sucre sur le dos", correct:false},
          {text:"D√©sol√©, √ßa co√ªte les yeux de la t√™te.", idiom:"co√ªter les yeux de la t√™te", correct:false}
        ]
      },
      // ‚Ä¶ total 4 scenarios ‚Ä¶
    ]
  };

  //
  // Initialization & Display Logic
  //
  document.addEventListener('DOMContentLoaded', initGame);

  function initGame() {
    updateDisplay();
  }

  function updateDisplay() {
    document.getElementById('totalScore').textContent = gameData.totalScore;
    document.getElementById('overallProgress').style.width =
      `${Math.min(gameData.totalScore/530*100,100)}%`; // Max score ~530

    for(let i=0;i<5;i++){
      const zoneEl = document.querySelector(`[data-zone="${i+1}"]`);
      const btn    = zoneEl.querySelector('button');
      const elements = zoneEl.querySelectorAll('h3, p, span');
      document.getElementById(`zone${i+1}Score`).textContent = `Score : ${gameData.zoneScores[i]}`;
      
      if(gameData.unlockedZones[i]){
        zoneEl.classList.remove('zone-locked');
        elements.forEach(el => {
            el.classList.remove('text-gray-400');
            if (el.tagName === 'H3') el.classList.add('text-blue-600');
            else el.classList.add('text-gray-600', 'text-gray-500');
        });
        btn.className='bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full font-semibold';
        btn.textContent=gameData.zoneScores[i]>0?'Rejouer':'Commencer l‚Äôaventure';
        btn.onclick=()=>startZone(i+1);
      }
    }
    // Update rank
    const rankEl=document.getElementById('playerRank');
    if(gameData.totalScore>=500) rankEl.textContent='Champion üèÜ';
    else if(gameData.totalScore>=400) rankEl.textContent='Explorateur üß≠';
    else rankEl.textContent='Continuez √† pratiquer üí°';
  }

  function startZone(zoneNum){
    gameData.currentZone=zoneNum;
    gameData.currentQuestion=0;
    document.getElementById('mainMenu').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    // hide all
    for(let z=1;z<=5;z++){
      document.getElementById(`zone${z}Game`).classList.add('hidden');
    }
    // show current
    document.getElementById(`zone${zoneNum}Game`).classList.remove('hidden');
    document.getElementById('zoneTitle').textContent     = zoneInfo[zoneNum].title;
    document.getElementById('zoneDescription').textContent = zoneInfo[zoneNum].desc;
    document.getElementById('currentScore').textContent = '0';

    // initialize each zone
    switch(zoneNum){
      case 1: initZone1(); break;
      case 2: initZone2(); break;
      case 3: initZone3(); break;
      case 4: initZone4(); break;
      case 5: initZone5(); break;
    }
  }

  function returnToMenu(){
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('mainMenu').classList.remove('hidden');
    updateDisplay();
  }

  //
  // ZONE 1: Match-Up Bay
  //
  function initZone1(){
    const idioms   = [...idiomsData.zone1];
    const meanings = [...idiomsData.zone1.map(i=>i.meaning)];
    // shuffle meanings
    for(let i=meanings.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [meanings[i],meanings[j]]=[meanings[j],meanings[i]];
    }
    gameData.gameState={idioms,meanings,matches:{}};
    renderMatchingGame();
  }

  function renderMatchingGame(){
    const colI = document.getElementById('idiomsColumn');
    const colM = document.getElementById('meaningsColumn');
    colI.innerHTML=''; colM.innerHTML='';
    gameData.gameState.idioms.forEach(i=>{
      const d=document.createElement('div');
      d.className='drag-item bg-blue-100 border-2 border-blue-300 p-3 rounded-lg text-center';
      d.draggable=true; d.textContent=i.idiom; d.dataset.idiom=i.idiom;
      d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i.idiom));
      colI.appendChild(d);
    });
    gameData.gameState.meanings.forEach(m=>{
      const dz=document.createElement('div');
      dz.className='drop-zone bg-gray-50 border-2 border-gray-300 p-3 rounded-lg text-center flex items-center justify-center min-h-[60px]';
      dz.textContent=m; dz.dataset.meaning=m;
      dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
      dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
      dz.addEventListener('drop',e=>{
        e.preventDefault(); dz.classList.remove('drag-over');
        const idiom=e.dataTransfer.getData('text/plain');
        gameData.gameState.matches[idiom]=dz.dataset.meaning;
        dz.innerHTML=`<div class="font-semibold text-blue-600">${idiom}</div><div class="text-sm text-gray-600">${dz.dataset.meaning}</div>`;
        dz.classList.add('bg-blue-50','border-blue-400');
        document.querySelector(`[data-idiom="${idiom}"]`).style.opacity='.3';
        updateMatchProgress();
      });
      colM.appendChild(dz);
    });
  }

  function updateMatchProgress(){
    const count=Object.keys(gameData.gameState.matches).length;
    document.getElementById('matchProgress').textContent=`${count}/10`;
    document.getElementById('matchProgressBar').style.width=`${count*10}%`;
  }

  function checkMatches(){
    let correct=0;
    gameData.gameState.idioms.forEach(item=>{
      const matchedMeaning = gameData.gameState.matches[item.idiom];
      const dropZoneEl = document.querySelector(`[data-meaning="${matchedMeaning}"]`);

      if(matchedMeaning===item.meaning){
        correct++;
        if (dropZoneEl) dropZoneEl.classList.add('correct-match');
      } else if(matchedMeaning){
        if (dropZoneEl) dropZoneEl.classList.add('wrong-match');
      }
    });
    const score=correct*10;
    gameData.zoneScores[0]=score;
    gameData.totalScore+=score;
    if(correct>=8) gameData.unlockedZones[1]=true;
    showResults(1,score,correct,gameData.gameState.idioms.length);
  }

  //
  // ZONE 2: True/False (FIXED)
  //
  function initZone2(){
    gameData.gameState={
      questions:[...idiomsData.zone2],
      currentQ:0,score:0,lives:3,correctAnswers:0
    };
    showTFQuestion();
  }

  function showTFQuestion(){
    const s=gameData.gameState;
    const q=s.questions[s.currentQ];
    document.getElementById('tfQuestionNum').textContent=s.currentQ+1;
    document.getElementById('livesCount').textContent= '‚ù§Ô∏è'.repeat(s.lives);
    document.getElementById('tfIdiom').textContent=q.idiom;
    document.getElementById('tfDefinition').textContent= `Signification : "${q.meaning}"`;
    document.getElementById('tfProgressBar').style.width=`${(s.currentQ+1)/s.questions.length*100}%`;
  }

  function answerTrueFalse(ans){
    const st=gameData.gameState;
    const q=st.questions[st.currentQ];
    if(ans===q.correct){
      st.score+=10; st.correctAnswers++;
    } else {
      st.lives--;
    }
    document.getElementById('currentScore').textContent=st.score;

    if (st.lives <= 0) {
        gameData.zoneScores[1] = st.score;
        gameData.totalScore += st.score;
        showResults(2, st.score, st.correctAnswers, st.questions.length, true); // game over
        return;
    }
    
    st.currentQ++;
    if(st.currentQ>=st.questions.length){
      gameData.zoneScores[1]=st.score;
      gameData.totalScore+=st.score;
      if (st.correctAnswers >= 8) gameData.unlockedZones[2]=true;
      showResults(2,st.score,st.correctAnswers,st.questions.length);
    } else {
      setTimeout(showTFQuestion,500);
    }
  }

  //
  // ZONE 3: Fill-in
  //
  function initZone3(){
    gameData.gameState={
      questions:[...idiomsData.zone3],
      currentQ:0,score:0,correctAnswers:0
    };
    showFIB();
  }

  function showFIB(){
    const s=gameData.gameState;
    const q=s.questions[s.currentQ];
    document.getElementById('fibQuestionNum').textContent=s.currentQ+1;
    document.getElementById('fibSentence').textContent=q.sentence;
    document.getElementById('fibProgressBar').style.width=`${(s.currentQ+1)/s.questions.length*100}%`;
    const sel=document.getElementById('fibSelect');
    sel.innerHTML='<option value="">Choisissez une expression‚Ä¶</option>';
    q.options.sort(() => Math.random() - 0.5).forEach(o=>{
      const opt=document.createElement('option');
      opt.value=o; opt.textContent=o; sel.appendChild(opt);
    });
  }

  function submitFillBlank(){
    const s=gameData.gameState;
    const q=s.questions[s.currentQ];
    const ans=document.getElementById('fibSelect').value;
    if(!ans){ alert('Veuillez choisir une expression.'); return; }
    if(ans===q.answer){
      s.score+=15; s.correctAnswers++;
    }
    document.getElementById('currentScore').textContent=s.score;
    s.currentQ++;
    if(s.currentQ>=s.questions.length){
      gameData.zoneScores[2]=s.score;
      gameData.totalScore+=s.score;
      if (s.correctAnswers >= (s.questions.length * 0.8)) gameData.unlockedZones[3]=true;
      showResults(3,s.score,s.correctAnswers,s.questions.length);
    } else {
      setTimeout(showFIB,500);
    }
  }

  //
  // ZONE 4: Lightning Round
  //
  function initZone4(){
    gameData.gameState={
      questions:[...idiomsData.zone4],
      currentQ:0,score:0,timeLeft:60,correctAnswers:0,timer:null
    };
    startTimer();
    showLR();
  }

  function startTimer(){
    const st=gameData.gameState;
    document.getElementById('timerDisplay').classList.remove('hidden');
    st.timer=setInterval(()=>{
      st.timeLeft--;
      document.getElementById('lrTimer').textContent=st.timeLeft;
      if(st.timeLeft<=10) document.getElementById('lrTimer').classList.add('timer-warning');
      if(st.timeLeft<=0){
        clearInterval(st.timer);
        finishLR();
      }
    },1000);
  }

  function showLR(){
    const st=gameData.gameState;
    const q=st.questions[st.currentQ];
    document.getElementById('lrQuestionNum').textContent=st.currentQ+1;
    document.getElementById('lrIdiom').textContent=q.idiom;
    document.getElementById('lrProgressBar').style.width=`${(st.currentQ+1)/st.questions.length*100}%`;
    const cont=document.getElementById('lrOptions');
    cont.innerHTML='';
    q.options.forEach((opt,i)=>{
      const btn=document.createElement('button');
      btn.className='bg-yellow-100 hover:bg-yellow-200 border-2 border-yellow-300 rounded-lg p-4 font-semibold';
      btn.textContent=opt;
      btn.onclick=()=>answerLR(i);
      cont.appendChild(btn);
    });
  }

  function answerLR(idx){
    const st=gameData.gameState;
    const q=st.questions[st.currentQ];
    if(idx===q.answer){
      st.score+=10; st.correctAnswers++;
    }
    document.getElementById('currentScore').textContent=st.score;
    st.currentQ++;
    if(st.currentQ>=st.questions.length||st.timeLeft<=0){
      finishLR();
    } else showLR();
  }

  function finishLR(){
    const st=gameData.gameState;
    clearInterval(st.timer);
    document.getElementById('timerDisplay').classList.add('hidden');
    gameData.zoneScores[3]=st.score;
    gameData.totalScore+=st.score;
    if (st.correctAnswers >= (st.questions.length * 0.8)) gameData.unlockedZones[4]=true;
    showResults(4,st.score,st.correctAnswers,st.questions.length);
  }

  //
  // ZONE 5: Scenario
  //
  function initZone5(){
    gameData.gameState={
      scenarios:[...idiomsData.zone5],
      currentS:0,score:0,correctAnswers:0
    };
    showScenario();
  }

  function showScenario(){
    const st=gameData.gameState;
    const sc=st.scenarios[st.currentS];
    document.getElementById('scenarioNum').textContent=st.currentS+1;
    document.getElementById('scenarioTitle').textContent=sc.title;
    document.getElementById('scenarioDescription').textContent=sc.description;
    document.getElementById('scenarioQuestion').textContent=sc.question;
    document.getElementById('scenarioProgressBar').style.width=`${(st.currentS+1)/st.scenarios.length*100}%`;
    const cont=document.getElementById('scenarioOptions');
    cont.innerHTML='';
    sc.options.forEach((opt,i)=>{
      const btn=document.createElement('button');
      btn.className='bg-purple-100 hover:bg-purple-200 border-2 border-purple-300 rounded-lg p-4 w-full text-left';
      btn.innerHTML=`<div class="font-semibold">${opt.text}</div><div class="text-sm text-gray-600 mt-1">Utilise : "${opt.idiom}"</div>`;
      btn.onclick=()=>answerScenario(i);
      cont.appendChild(btn);
    });
  }

  function answerScenario(idx){
    const st=gameData.gameState;
    const sc=st.scenarios[st.currentS];
    if(sc.options[idx].correct){
      st.score+=20; st.correctAnswers++;
    }
    document.getElementById('currentScore').textContent=st.score;
    st.currentS++;
    if(st.currentS>=st.scenarios.length){
      gameData.zoneScores[4]=st.score;
      gameData.totalScore+=st.score;
      showResults(5,st.score,st.correctAnswers,st.scenarios.length);
    } else setTimeout(showScenario,500);
  }

  //
  // RESULTS MODAL (FIXED)
  //
  function showResults(zone,score,correct,total, gameOver = false){
    const modal=document.getElementById('resultsModal');
    const icon=document.getElementById('resultsIcon');
    const title=document.getElementById('resultsTitle');
    const msg=document.getElementById('resultsMessage');
    const sc=document.getElementById('resultsScore');
    const pct = total > 0 ? Math.round(correct / total * 100) : 0;
    
    if (gameOver) {
        icon.textContent = 'üíî';
        title.textContent = 'Partie termin√©e !';
        msg.textContent = 'Vous n\'avez plus de vies. Entra√Ænez-vous et r√©essayez !';
    } else if(pct>=80){
      icon.textContent='üéâ'; title.textContent='Excellent !'; msg.textContent=`Vous avez ma√Ætris√© cette zone avec ${pct}% de bonnes r√©ponses !`;
    } else if(pct>=60){
      icon.textContent='üëç'; title.textContent='Bien jou√© !'; msg.textContent=`Vous avez obtenu ${pct}% de bonnes r√©ponses. Continuez !`;
    } else {
      icon.textContent='üí™'; title.textContent='Continuez d\'essayer !'; msg.textContent=`Vous avez obtenu ${pct}% de bonnes r√©ponses. La pratique rend parfait !`;
    }
    sc.textContent=`+${score} pts`;
    modal.classList.remove('hidden');
  }

  function closeResults(){
    document.getElementById('resultsModal').classList.add('hidden');
    returnToMenu();
  }
  </script>
</body>
</html>